{% extends "menu.html" %}
{% block title %}Детали задания{% endblock title %}
{% block content %}
<div class="task-detail">
    <div class="task-info">
        <div class="header-container">
            <h2>Основная информация</h2>
            <a href="../" class="back-btn">Вернуться к списку заданий</a>
        </div>
        <div class="info-grid">
            <div class="info-label">Оператор:</div>
            <div>{{ task.user }}</div>
            
            <div class="info-label">Тема:</div>
            <div>{{ task.subject }}</div>
            
            <div class="info-label">Статус:</div>
            <div>{{ task.status }}</div>
            
            <div class="info-label">Дата выдачи:</div>
            <div>{{ task.start_date|date:"d.m.Y" }}</div>
            
            <div class="info-label">Дата исполнения:</div>
            <div>{{ task.end_date|date:"d.m.Y" }}</div>
        </div>
    </div>

    <div class="data-section">
        <h3>Прикрепленные файлы</h3>
        {% if task.file %}
            <div style="margin-bottom: 1rem;">
                <a href="{% url 'download_file' task.id %}" class="details-btn" download>
                    Скачать файл
                </a>
                <span>{{ task.file_name }}</span>
            </div>
        {% else %}
            <p>Файлы не прикреплены</p>
        {% endif %}

        {% if request.user.groups.all.0.name == 'main' or request.user == task.user %}
        <form method="post" enctype="multipart/form-data" action="{% url 'upload_file' task.id %}">
            {% csrf_token %}
            <input type="file" name="file" id="file" style="margin-bottom: 0.5rem;">
            <button type="submit" class="details-btn">Загрузить файл</button>
            {% if task.file %}
                <button type="submit" name="delete_file" class="details-btn" style="background-color: #e74c3c;">
                    Удалить файл
                </button>
            {% endif %}
        </form>
        {% endif %}
    </div>

    <div style="margin-bottom: 1rem;">
    {% if request.user.groups.all.0.name == 'main' %}
        {% if status == 'review' %}

        <div style="margin-bottom: 0.5rem;">
            <a href="complete" class="details-btn">Принять на реализацию</a>
            <a href="revision" class="details-btn">Отправить на доработку</a>
        </div>
        {% endif %}
        <a href="cancel" class="details-btn">Отменить</a>
        <a href="edit" class="details-btn">Изменить</a>
        <a href="delete" class="details-btn" style="background-color: #e74c3c;">Удалить</a>
    {% endif %}

    {% if request.user.groups.all.0.name == 'user' %}
        {% if status == 'new' or status == 'revision' %}
        <a href="accept" class="details-btn">Принять в работу</a>
        {% endif %}

        {% if status == 'in_progress' %}
        <a href="review" class="details-btn">Отправить на проверку</a>
        {% endif %}
    {% endif %}
    </div>

    <div class="related-data">
        <h2>Связанные данные</h2>
        
        <div class="data-section">
            <h3>Связанные лица</h3>
            <ul>
                {% for person in task.persons.all %}
                    <li>
                        <span>{{ person.person }}</span>
                        {% include "includes/copy_button.html" %}
                    </li>
                {% empty %}
                    <li>Нет связанных лиц</li>
                {% endfor %}
            </ul>
        </div>

        <div class="data-section">
            <h3>Телефонные номера</h3>
            <ul>
                {% for number in task.phoneNumbers.all %}
                    <li>
                        <span>{{ number.numbers }}</span>
                        {% include "includes/copy_button.html" %}
                    </li>
                {% empty %}
                    <li>Нет телефонных номеров</li>
                {% endfor %}
            </ul>
        </div>

        <div class="data-section">
            <h3>Аккаунты</h3>
            <ul>
                {% for account in task.accounts.all %}
                    <li>
                        <span>{{ account.account }}</span>
                        {% include "includes/copy_button.html" %}
                    </li>
                {% empty %}
                    <li>Нет аккаунтов</li>
                {% endfor %}
            </ul>
        </div>
        
        <div class="data-section">
            <h3>Email адреса</h3>
            <ul>
                {% for email in task.emails.all %}
                    <li>
                        <span>{{ email.email }}</span>
                        {% include "includes/copy_button.html" %}
                    </li>
                {% empty %}
                    <li>Нет email адресов</li>
                {% endfor %}
            </ul>
        </div>

    </div>
    {% if request.user.groups.all.0.name == 'main' %}
    <div>
        <a href="data" class="details-btn">Изменить связные данные</a>
    </div>
    {% endif %}
</div>
<script>
function copyToClipboard(button) {
    const textToCopy = button.previousElementSibling.textContent;
    navigator.clipboard.writeText(textToCopy).then(() => {
        const originalHTML = button.innerHTML;
        button.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M20 6L9 17l-5-5"/></svg>';
        button.style.color = '#2ecc71';

        setTimeout(() => {
            button.innerHTML = originalHTML;
            button.style.color = '';
        }, 500);
    }).catch(err => {
        console.error('Ошибка при копировании: ', err);
        button.textContent = 'Ошибка';
        button.style.color = '#e74c3c';
    });
}
</script>
{% endblock content %}