{% extends "menu.html" %}
{% block title %}Tasker{% endblock title %}
{% block content %}
<div class="container">
    <h2>Добавление связанных данных для задачи #{{ task.id }}</h2>

    <form method="post">
        {% csrf_token %}

        <div class="card mb-4">
            <div class="card-header">
                <h3>Добавить людей</h3>
                <button type="button" class="btn btn-sm btn-success add-form" data-form-prefix="persons">+ Добавить еще</button>
            </div>
            <div class="card-body" id="persons-forms">
                {{ person_formset.management_form }}
                {% for form in person_formset %}
                <div class="person-form mb-3">
                    {{ form.as_p }}
                </div>
                {% endfor %}
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header">
                <h3>Добавить интернет-аккаунты</h3>
                <button type="button" class="btn btn-sm btn-success add-form" data-form-prefix="internet">+ Добавить еще</button>
            </div>
            <div class="card-body" id="internet-forms">
                {{ internet_formset.management_form }}
                {% for form in internet_formset %}
                <div class="internet-form mb-3">
                    {{ form.as_p }}
                </div>
                {% endfor %}
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header">
                <h3>Добавить email-адреса</h3>
                <button type="button" class="btn btn-sm btn-success add-form" data-form-prefix="emails">+ Добавить еще</button>
            </div>
            <div class="card-body" id="emails-forms">
                {{ email_formset.management_form }}
                {% for form in email_formset %}
                <div class="email-form mb-3">
                    {{ form.as_p }}
                </div>
                {% endfor %}
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header">
                <h3>Добавить телефонные номера</h3>
                <button type="button" class="btn btn-sm btn-success add-form" data-form-prefix="phones">+ Добавить еще</button>
            </div>
            <div class="card-body" id="phones-forms">
                {{ phone_formset.management_form }}
                {% for form in phone_formset %}
                <div class="phone-form mb-3">
                    {{ form.as_p }}
                </div>
                {% endfor %}
            </div>
        </div>

        <button type="submit" class="btn btn-primary">Сохранить все данные</button>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Функция для добавления новых форм
    function addForm(prefix) {
        const formContainer = document.getElementById(`${prefix}-forms`);
        const totalForms = document.getElementById(`id_${prefix}-TOTAL_FORMS`);
        const formCount = parseInt(totalForms.value);

        // Создаем новую форму (просто копируем последнюю)
        const newForm = formContainer.querySelector(`.${prefix}-form:last-child`).cloneNode(true);

        // Очищаем значения и обновляем индексы
        newForm.querySelectorAll('input').forEach(input => {
            input.value = '';
            input.name = input.name.replace(/-\d+-/, `-${formCount}-`);
            input.id = input.id.replace(/-\d+-/, `-${formCount}-`);
        });

        // Добавляем новую форму
        formContainer.appendChild(newForm);

        // Обновляем счетчик форм
        totalForms.value = formCount + 1;
    }

    // Обработчики для кнопок "Добавить еще"
    document.querySelectorAll('.add-form').forEach(button => {
        button.addEventListener('click', function() {
            const prefix = this.dataset.formPrefix;
            addForm(prefix);
        });
    });
});
</script>

<style>
.add-form {
    float: right;
}
.form-row {
    margin-bottom: 15px;
}
</style>
{% endblock content %}